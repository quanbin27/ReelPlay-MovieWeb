<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<!-- CSS -->
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/splide.min.css">
	<link rel="stylesheet" href="css/slimselect.css">
	<link rel="stylesheet" href="css/plyr.css">
	<link rel="stylesheet" href="css/photoswipe.css">
	<link rel="stylesheet" href="css/default-skin.css">
	<link rel="stylesheet" href="css/main.css">

	<!-- Icon font -->
	<link rel="stylesheet" href="webfont/tabler-icons.min.css">

	<!-- Favicons -->
	<link rel="icon" type="image/png" href="icon/favicon-32x32.png" sizes="32x32">
	<link rel="apple-touch-icon" href="icon/favicon-32x32.png">
	<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

	<meta name="description" content="Online Movies, TV Shows & Cinema HTML Template">
	<meta name="keywords" content="">
	<meta name="author" content="Dmitry Volkov">
	<title>ReelPlay – Online Movies, TV Shows & Cinema HTML Template</title>
</head>

<body>
	<!-- header -->
	<header class="header">
		<div class="container">
			<div class="row">
				<div class="col-12">
					<div class="header__content">
						<!-- header logo -->
						<a href="/index" class="header__logo">
							<img src="img/logo.svg" alt="">
						</a>
						<!-- end header logo -->

						<!-- header nav -->
						<ul class="header__nav">
							<!-- dropdown -->
							<li class="header__nav-item">
								<a class="header__nav-link" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Category <i class="ti ti-chevron-down"></i></a>

								<ul class="dropdown-menu header__dropdown-menu">
									<li><a href="/search?q=action&page=1&limit=54">Action</a></li>
									<li><a href="/search?q=adventure&page=1&limit=54">Adventure</a></li>
									<li><a href="/search?q=comedy&page=1&limit=54">Comedy</a></li>
									<li><a href="/search?q=document&page=1&limit=54">Document</a></li>
									<li><a href="/search?q=drama&page=1&limit=54">Drama</a></li>
									<li><a href="/search?q=family&page=1&limit=54">Family</a></li>
									<li><a href="/search?q=horror&page=1&limit=54">Horror</a></li>
									<li><a href="/search?q=romance&page=1&limit=54">Romance</a></li>
									<li><a href="/search?q=sci-fi&page=1&limit=54">Sci-Fi</a></li>
									<li><a href="/search?q=sport&page=1&limit=54">Sport</a></li>

								</ul>
							</li>
							<!-- end dropdown -->

							<!-- dropdown -->
							<li class="header__nav-item">
								<a class="header__nav-link" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Country <i class="ti ti-chevron-down"></i></a>

								<ul class="dropdown-menu header__dropdown-menu-grid" style="">
									<li><a href="/search?q=china&page=1&limit=54">China</a></li>
									<li><a href="/search?q=south+korea&page=1&limit=54">South Korea</a></li>
									<li><a href="/search?q=japan&page=1&limit=54">Japan</a></li>
									<li><a href="/search?q=thailand&page=1&limit=54">Thailand</a></li>
									<li><a href="/search?q=western+countries&page=1&limit=54">Western Countries</a></li>
									<li><a href="/search?q=taiwan&page=1&limit=54">Taiwan</a></li>
									<li><a href="/search?q=hong+kong&page=1&limit=54">Hong Kong</a></li>
									<li><a href="/search?q=india&page=1&limit=54">India</a></li>
									<li><a href="/search?q=united+kingdom&page=1&limit=54">United Kingdom</a></li>
									<li><a href="/search?q=france&page=1&limit=54">France</a></li>
									<li><a href="/search?q=canada&page=1&limit=54">Canada</a></li>
									<li><a href="/search?q=other+countries&page=1&limit=54">Other Countries</a></li>
									<li><a href="/search?q=germany&page=1&limit=54">Germany</a></li>
									<li><a href="/search?q=spain&page=1&limit=54">Spain</a></li>
									<li><a href="/search?q=turkey&page=1&limit=54">Turkey</a></li>
									<li><a href="/search?q=netherlands&page=1&limit=54">Netherlands</a></li>
									<li><a href="/search?q=indonesia&page=1&limit=54">Indonesia</a></li>
									<li><a href="/search?q=russia&page=1&limit=54">Russia</a></li>
									<li><a href="/search?q=mexico&page=1&limit=54">Mexico</a></li>
									<li><a href="/search?q=poland&page=1&limit=54">Poland</a></li>
									<li><a href="/search?q=australia&page=1&limit=54">Australia</a></li>
									<li><a href="/search?q=sweden&page=1&limit=54">Sweden</a></li>
									<li><a href="/search?q=malaysia&page=1&limit=54">Malaysia</a></li>
									<li><a href="/search?q=brazil&page=1&limit=54">Brazil</a></li>
									<li><a href="/search?q=philippines&page=1&limit=54">Philippines</a></li>
									<li><a href="/search?q=portugal&page=1&limit=54">Portugal</a></li>
									<li><a href="/search?q=italy&page=1&limit=54">Italy</a></li>
									<li><a href="/search?q=denmark&page=1&limit=54">Denmark</a></li>
									<li><a href="/search?q=uae&page=1&limit=54">UAE</a></li>
									<li><a href="/search?q=norway&page=1&limit=54">Norway</a></li>
									<li><a href="/search?q=switzerland&page=1&limit=54">Switzerland</a></li>
									<li><a href="/search?q=africa&page=1&limit=54">Africa</a></li>
									<li><a href="/search?q=south+africa&page=1&limit=54">South Africa</a></li>
									<li><a href="/search?q=ukraine&page=1&limit=54">Ukraine</a></li>
									<li><a href="/search?q=saudi+arabia&page=1&limit=54">Saudi Arabia</a></li>
									<li><a href="/search?q=others&page=1&limit=54">Others</a></li>

								</ul>
							</li>
							<!-- end dropdown -->

							<li class="header__nav-item">
								<a href="/new-movie" class="header__nav-link">New movies</a>
							</li>

							<!-- dropdown -->
							<li class="header__nav-item">
								<a class="header__nav-link" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Pages <i class="ti ti-chevron-down"></i></a>

								<ul class="dropdown-menu header__dropdown-menu">
									<li><a href="/about">About Us</a></li>
									<li><a href="/contacts">Contacts</a></li>
									<li><a href="/faq">Help center</a></li>
									<li><a href="/privacy">Privacy policy</a></li>
								</ul>
							</li>
							<!-- end dropdown -->

							<!-- dropdown -->
							<li class="header__nav-item">
								<a class="header__nav-link header__nav-link--more" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="ti ti-dots"></i></a>

								<ul class="dropdown-menu header__dropdown-menu">
									<li><a href="/new-feature">Feature Film</a></li>
									<li><a href="/new-series">New Series</a></li>
								</ul>
							</li>
							<!-- end dropdown -->
						</ul>
						<!-- end header nav -->

						<!-- header auth -->
						<div class="header__auth">
							<form action="#" class="header__search">
								<input class="header__search-input" id="search-input" type="text" placeholder="Search...">
								<button class="header__search-button" type="button" id="search-btn">
									<i class="ti ti-search"></i>
								</button>
								<button class="header__search-close" type="button">
									<i class="ti ti-x"></i>
								</button>
							</form>


							<button class="header__search-btn" type="button">
								<i class="ti ti-search"></i>
							</button>

							<div class="header__profile">
								<a href="#" class="header__sign-in header__sign-in--user" role="button" id="profileLink">
									<i class="ti ti-user"></i>
									<span id="profileText">SIGN IN</span>
								</a>
							</div>
							<!-- end dropdown -->
						</div>
						<!-- end header auth -->

					</div>
				</div>
			</div>
		</div>
	</header>
	<!-- end header -->

	<!-- details -->
	<section class="section section--details">
		<!-- details background -->
		<div class="section__details-bg" data-bg="img/bg/details__bg.jpg"></div>
		<!-- end details background -->

		<!-- details content -->
		<div class="container">
			<div class="row">
				<!-- title -->
				<div id="bookmarkMessage" class="message col-12" style="color: white"></div>

				<div class="col-12">
					<h1 class="section__title section__title--head" id="movie-title">Movie Title</h1>
				</div>
				<!-- player -->
				<div class="col-12 col-xl-8">
					<div class="section__player">

						<video id="video-player" controls width="100%" height="100%">
							Your browser does not support the video tag.
						</video>

					</div>


					<div class="episode-buttons" id="episode-buttons-container">
						<!-- Các nút cho từng tập sẽ được thêm vào đây -->
					</div>
					<div class="rating-container">
						<h3 class="rating-header">Rate this movie</h3>
						<div class="star-rating-wrapper">
							<div class="star-rating">
								<span class="star" data-value="1">&#9733;</span>
								<span class="star" data-value="2">&#9733;</span>
								<span class="star" data-value="3">&#9733;</span>
								<span class="star" data-value="4">&#9733;</span>
								<span class="star" data-value="5">&#9733;</span>
								<span class="star" data-value="6">&#9733;</span>
								<span class="star" data-value="7">&#9733;</span>
								<span class="star" data-value="8">&#9733;</span>
								<span class="star" data-value="9">&#9733;</span>
								<span class="star" data-value="10">&#9733;</span>
							</div>
							<button id="submit-rating" class="submit-rating-btn">Submit Rating</button>
						</div>
					</div>
					<div class="rating-fit-container">
						<h3 class="rating-header" style="text-align: center">How Well Does the Category Fit?</h3>
						<div class="star-rating-wrapper">
							<div class="star-fit-rating">
								<span class="star-fit" data-value="1">&#9733;</span>
								<span class="star-fit" data-value="2">&#9733;</span>
								<span class="star-fit" data-value="3">&#9733;</span>
								<span class="star-fit" data-value="4">&#9733;</span>
								<span class="star-fit" data-value="5">&#9733;</span>
								<span class="star-fit" data-value="6">&#9733;</span>
								<span class="star-fit" data-value="7">&#9733;</span>
								<span class="star-fit" data-value="8">&#9733;</span>
								<span class="star-fit" data-value="9">&#9733;</span>
								<span class="star-fit" data-value="10">&#9733;</span>
							</div>
							<button id="submit-fit-rating" class="submit-rating-btn">Submit Rating</button>
						</div>
					</div>
					<div class="comments">
						<ul class="comments__list">
							<!-- Bình luận sẽ được thêm vào đây bởi JavaScript -->
						</ul>

						<!-- Button "More comments" -->
						<div class="load-more-comments">
							<button id="more-comments" class="sign__btn sign__btn--small">More comments</button>
						</div>

						<form id="comment-form" class="sign__form sign__form--comments">
							<div class="sign__group">
								<textarea id="comment-content" name="text" class="sign__textarea" placeholder="Add comment" required></textarea>
							</div>
							<button type="submit" id="submit-comment" class="sign__btn sign__btn--small">Send</button>
						</form>


					</div>

				</div>
				<!-- end player -->
				<div class="col-12 col-lg-4">
					<div class="row" id="mostview">

					</div>

				</div>
				<div class="col-12 col-xl-3">
<!--					<div class="item item--details">-->
<!--						<div class="row">-->
<!--							<div class="col-12 col-sm-5 col-md-5 col-lg-4 col-xl-6 col-xxl-5">-->
<!--								<div class="item__cover">-->
<!--									<img id="movie-thumbnail" src="" alt="">-->
<!--									<span class="item__rate item__rate--green" id="movie-rate"></span>-->
<!--									<button id="bookmarkBtn" class="item__favorite unbookmarked" type="button">-->
<!--										<i class="ti ti-bookmark"></i>-->
<!--									</button>-->

<!--								</div>-->
<!--							</div>-->

<!--							<div class="col-12 col-md-7 col-lg-8 col-xl-6 col-xxl-7">-->
<!--								<div class="item__content">-->
<!--									<ul class="item__meta">-->
<!--										<li><span>Director:</span> <span id="movie-director"></span></li>-->
<!--										<li><span>Actor:</span> <span id="movie-actor"></span></li>-->
<!--										<li><span>Category:</span> <span id="movie-category"></span></li>-->
<!--										<li><span>Release Year:</span> <span id="movie-year"></span></li>-->
<!--										<li><span>Language:</span> <span id="movie-language"></span></li>-->
<!--										<li><span>Number of episodes:</span> <span id="movie-num-episodes"></span></li>-->
<!--										<li><span>Country:</span> <span id="movie-country"></span></li>-->
<!--										<li><span>Views:</span> <span id="movie-view"></span></li>-->
<!--									</ul>-->

<!--									<div class="item__description">-->
<!--										<p id="movie-description"></p>-->
<!--									</div>-->
<!--								</div>-->
<!--							</div>-->
<!--						</div>-->
<!--					</div>-->


				</div>
				 end content


			</div>
		</div>
		<!-- end details content -->
	</section>
	<!-- end details -->

	<!-- content -->
	<section class="content">
		<div class="content__head content__head--mt">
			<div class="container">
				<div class="row">
					<div class="col-12">
						<!-- content title -->
						<!-- end content title -->

						<!-- content tabs nav -->
						<ul class="nav nav-tabs content__tabs" id="content__tabs" role="tablist">
							<li class="nav-item" role="presentation">
								<button id="1-tab" class="active" data-bs-toggle="tab" data-bs-target="#tab-1" type="button" role="tab" aria-controls="tab-1" aria-selected="true">Comments</button>
							</li>

<!--							<li class="nav-item" role="presentation">-->
<!--								<button id="2-tab" data-bs-toggle="tab" data-bs-target="#tab-2" type="button" role="tab" aria-controls="tab-2" aria-selected="false">Reviews</button>-->
<!--							</li>-->

<!--							<li class="nav-item" role="presentation">-->
<!--								<button id="3-tab" data-bs-toggle="tab" data-bs-target="#tab-3" type="button" role="tab" aria-controls="tab-3" aria-selected="false">Photos</button>-->
<!--							</li>-->
						</ul>
						<!-- end content tabs nav -->
					</div>
				</div>
			</div>
		</div>

		<div class="container">
			<div class="row">
				<div class="col-12 ">
					<!-- content tabs -->
					<div class="tab-content">
						<div class="tab-pane fade show active" id="tab-1" role="tabpanel" aria-labelledby="1-tab" tabindex="0">
							<div class="row">
								<!-- comments -->
								<div class="col-12">

								</div>
								<!-- end comments -->
							</div>
						</div>

					</div>
					<!-- end content tabs -->
				</div>

				<!-- sidebar -->

				<!-- end sidebar -->
			</div>
		</div>
	</section>
	<!-- end content -->

	<!-- footer -->
	<footer class="footer">
		<div class="container">
			<div class="row">
				<div class="col-12">
					<div class="footer__content">
						<a href="/index" class="footer__logo">
							<img src="img/logo.svg" alt="">
						</a>


						<nav class="footer__nav">
							<a href="/about">About Us</a>
							<a href="/contacts">Contacts</a>
							<a href="/privacy">Privacy policy</a>
						</nav>

						<button class="footer__back" type="button">
							<i class="ti ti-arrow-narrow-up"></i>
						</button>
					</div>
				</div>
			</div>
		</div>
	</footer>
	<!-- end footer -->

	<!-- Root element of PhotoSwipe. Must have class pswp. -->
	<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

		<!-- Background of PhotoSwipe. 
		It's a separate element, as animating opacity is faster than rgba(). -->
		<div class="pswp__bg"></div>

		<!-- Slides wrapper with overflow:hidden. -->
		<div class="pswp__scroll-wrap">

			<!-- Container that holds slides. PhotoSwipe keeps only 3 slides in DOM to save memory. -->
			<!-- don't modify these 3 pswp__item elements, data is added later on. -->
			<div class="pswp__container">
				<div class="pswp__item"></div>
				<div class="pswp__item"></div>
				<div class="pswp__item"></div>
			</div>

			<!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
			<div class="pswp__ui pswp__ui--hidden">

				<div class="pswp__top-bar">

					<!--  Controls are self-explanatory. Order can be changed. -->

					<div class="pswp__counter"></div>

					<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

					<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

					<!-- Preloader -->
					<div class="pswp__preloader">
						<div class="pswp__preloader__icn">
							<div class="pswp__preloader__cut">
								<div class="pswp__preloader__donut"></div>
							</div>
						</div>
					</div>
				</div>

				<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>

				<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

				<div class="pswp__caption">
					<div class="pswp__caption__center"></div>
				</div>
			</div>
		</div>
	</div>

	<!-- JS -->
	<script src="js/bootstrap.bundle.min.js"></script>
	<script src="js/splide.min.js"></script>
	<script src="js/slimselect.min.js"></script>
	<script src="js/smooth-scrollbar.js"></script>
	<script src="js/plyr.min.js"></script>
	<script src="js/photoswipe.min.js"></script>
	<script src="js/photoswipe-ui-default.min.js"></script>
	<script src="js/main.js"></script>
	<script>
		document.addEventListener('DOMContentLoaded', async function() {
			const video = document.getElementById('video-player');
			const userId = getUserIdFromToken();
			const movieId = getMovieIdFromURL(); // Hàm lấy movieId từ URL
			const episode = getEpisodeNumberFromURL(); // Hàm lấy episode từ URL

			try {
				// Gọi API để lấy thông tin về tập phim
				const response = await fetch(`http://localhost:8080/api/v1/movie/${movieId}/episode/${episode}`, {
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${localStorage.getItem('token')}`
					}
				});

				if (!response.ok) {
					if (response.status === 401) {
						// Chuyển hướng tới trang đăng nhập nếu không đăng nhập
						window.location.href = '/signin'; // Thay đổi URL này thành trang đăng nhập của bạn
					} else {
						throw new Error('Không thể lấy dữ liệu tập phim');
					}
				}


				const episodeData = await response.json();
				localStorage.setItem('episode_id', episodeData.id);
				const episodeId = episodeData.id;

				// Sử dụng source từ API để phát video
				const videoSrc = episodeData.source;
				await createUserWatched(userId, episodeId);

				const lastPosition = await getWatchPosition(userId, episodeId);


				if (lastPosition > 0) {
					const confirmJump = confirm(`You have watched up to ${lastPosition} seconds. Do you want to continue from that point?`);
					if (confirmJump) {
						video.currentTime = lastPosition;
					}
				}

				if (Hls.isSupported()) {
					const hls = new Hls();
					hls.loadSource(videoSrc);
					hls.attachMedia(video);
					hls.on(Hls.Events.MANIFEST_PARSED, function() {
						video.play();
					});
				} else if (video.canPlayType('application/vnd.apple.mpegurl')) {
					video.src = videoSrc;
					video.addEventListener('loadedmetadata', function() {
						video.play();
					});
				} else {
					console.error('HLS không được hỗ trợ trên trình duyệt này.');
				}

				let updateInterval = null;

				video.addEventListener('play', () => {
					console.log('Video is playing. Starting position update...');
					updateInterval = setInterval(async () => {
						const currentPosition = Math.floor(video.currentTime);
						console.log(`Current position: ${currentPosition} seconds`);

						try {
							await updateWatchPosition(userId, episodeId, currentPosition);
							console.log('Watch position updated successfully');
						} catch (error) {
							console.error('Error updating watch position:', error);
						}
					}, 30000); // Lưu vị trí mỗi 30 giây
				});

				video.addEventListener('pause', () => {
					console.log('Video is paused. Clearing update interval.');
					clearInterval(updateInterval);
				});

				window.addEventListener('beforeunload', async () => {
					const currentPosition = Math.floor(video.currentTime);
					console.log(`Window is unloading. Saving current position: ${currentPosition} seconds`);

					try {
						await updateWatchPosition(userId, episodeId, currentPosition);
						console.log('Watch position updated on unload successfully');
					} catch (error) {
						console.error('Error updating watch position on unload:', error);
					}
				});
			} catch (error) {
				console.error('Error:', error);
			}
		});


		// Hàm tạo bản ghi user_watched
		async function createUserWatched(userId, episodeId) {
			try {
				const response = await fetch(`http://localhost:8080/api/v1/watch-position?user_id=${userId}&episode_id=${episodeId}`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${localStorage.getItem('token')}` // Gửi token trong header
					}
				});

				if (!response.ok) {
					throw new Error('Failed to create user watched record');
				}
			} catch (error) {
				console.error('Error creating user watched:', error);
			}
		}

		// Hàm lấy vị trí xem
		async function getWatchPosition(userId, episodeId) {
			try {
				const response = await fetch(`http://localhost:8080/api/v1/watch-position?user_id=${userId}&episode_id=${episodeId}`, {
					method: 'GET',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${localStorage.getItem('token')}` // Gửi token trong header
					}
				});

				if (!response.ok) {
					throw new Error('Failed to get watch position');
				}

				const data = await response.json();
				return data.last_position;
			} catch (error) {
				console.error('Error getting watch position:', error);
				return 0; // Trả về 0 nếu có lỗi
			}
		}

		// Hàm cập nhật vị trí xem
		async function updateWatchPosition(userId, episodeId, position) {
			try {
				const response = await fetch(`http://localhost:8080/api/v1/watch-position?user_id=${userId}&episode_id=${episodeId}&position=${position}`, {
					method: 'PUT',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${localStorage.getItem('token')}` // Gửi token trong header
					}
				});

				if (!response.ok) {
					throw new Error('Failed to update watch position');
				}
			} catch (error) {
				console.error('Error updating watch position:', error);
			}
		}


		const urlParams = new URLSearchParams(window.location.search);
		const movieId = urlParams.get('movieId'); // Thay đổi tùy theo cách bạn lấy ID

		// Hàm để lấy dữ liệu phim
		async function fetchMovieData(movieId) {
			try {
				const response = await fetch(`http://localhost:8080/api/v1/movie/${movieId}`);
				if (!response.ok) {
					throw new Error('Không thể lấy dữ liệu phim');
				}
				const movieData = await response.json();
				displayMovieData(movieData);
			} catch (error) {
				console.error(error);
			}
		}

		// Hàm để hiển thị dữ liệu phim
		function displayMovieData(movie) {
			document.getElementById('movie-title').innerText = movie.name;
			const movieId = getMovieIdFromURL(); // Hàm lấy movieId từ URL
			const episodeURL=parseInt(getEpisodeNumberFromURL(), 10);
			console.log(episodeURL);
			// Chọn container để thêm các nút
			const buttonsContainer = document.getElementById('episode-buttons-container');
			if (movie.numEpisodes>1){
				for (let episode = 1; episode <= movie.numEpisodes; episode++) {
					const button = document.createElement('button');
					button.textContent = `Episode ${episode}`;
					button.classList.add('section__item-buttons');
					if (episode === episodeURL ) {
						button.classList.add('playing-episode');
					}
					// Thêm sự kiện click cho nút để chuyển tới trang xem phim
					button.addEventListener('click', () => {
						window.location.href = `/watch?movieId=${movieId}&episode=${episode}`;
					});

					// Thêm nút vào container
					buttonsContainer.appendChild(button);
				}
			}


		}

		// Gọi hàm để lấy dữ liệu
		if (movieId) {
			fetchMovieData(movieId);
		} else {
			console.error('ID phim không hợp lệ');
		}
		// Khai báo biến toàn cục
		// Khai báo biến toàn cục
		let comments = [];  // Biến lưu trữ tất cả bình luận
		let currentPage = 1;  // Biến theo dõi số lần nhấn nút "More comments"
		const commentsPerPage = 7;  // Số bình luận tải ban đầu
		const additionalComments = 5;  // Số bình luận tải thêm mỗi lần nhấn "More comments"

		// Hàm để lấy bình luận từ API
		async function fetchComments() {
			try {
				const movieId = getMovieIdFromURL(); // Lấy movieId từ URL
				const response = await fetch(`http://localhost:8080/api/v1/movie/${movieId}/comment`);

				if (response.ok) {
					comments = await response.json();
					displayComments();  // Hiển thị bình luận sau khi lấy về
				} else {
					console.error('Error fetching comments:', response.status, await response.text());
				}
			} catch (error) {
				console.error("Error fetching comments:", error);
			}
		}

		// Hàm để hiển thị bình luận
		function displayComments() {
			const commentsList = document.querySelector('.comments__list');
			commentsList.innerHTML = '';  // Clear danh sách cũ
			if (!comments || comments.length === 0) {
				// Nếu không có bình luận, hiển thị thông báo hoặc xử lý logic khác
				commentsList.innerHTML = '<li class="comments__item" style="color: white">No comments available</li>';
				return;
			}
			const start = 0;
			const end = commentsPerPage * currentPage;
			const commentsToDisplay = comments.slice(start, end);

			commentsToDisplay.forEach(comment => {
				const commentItem = document.createElement('li');
				commentItem.classList.add('comments__item');

				commentItem.innerHTML = `
            <div class="comments__autor">
                <img class="comments__avatar" src="img/user.svg" alt="">
                <span class="comments__name">${comment.user_name}</span>
                <span class="comments__time">${formatDate(comment.created_at)}</span>
            </div>
            <p class="comments__text">${comment.content}</p>
        `;

				commentsList.appendChild(commentItem);
			});

			// Kiểm tra xem có bình luận nào còn để hiển thị không
			if (commentsToDisplay.length >= comments.length) {
				document.getElementById('more-comments').style.display = 'none';  // Ẩn nút "More comments" nếu không còn bình luận
			}
		}

		// Hàm để tải thêm bình luận khi nhấn "More comments"
		function loadMoreComments() {
			currentPage++;
			displayComments();
		}

		// Hàm để định dạng lại ngày tháng
		function formatDate(dateString) {
			const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
			const date = new Date(dateString);
			return date.toLocaleDateString('en-GB', options);
		}

		// Hàm để lấy token và userId từ localStorage
		function getUserIdFromToken() {
			const token = localStorage.getItem('token');
			if (!token) return null;

			// Giả sử token là JWT, bạn có thể phân tích nó để lấy userId
			const payload = JSON.parse(atob(token.split('.')[1]));
			return payload.user_id; // Lưu ý: thay đổi 'userId' thành 'user_id' cho đúng với payload
		}

		// Hàm để lấy movieId từ URL
		function getMovieIdFromURL() {
			const urlParams = new URLSearchParams(window.location.search);
			return urlParams.get('movieId'); // Giả sử movieId là một tham số trong URL với tên là 'movieId'
		}
		function getEpisodeNumberFromURL() {
			const urlParams = new URLSearchParams(window.location.search);
			return urlParams.get('episode');
		}

		// Hàm để thêm comment
		async function addComment(userId, movieId, content) {
			const response = await fetch(`http://localhost:8080/api/v1/comment`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'Authorization': `Bearer ${localStorage.getItem('token')}` // Gửi token trong header
				},
				body: JSON.stringify({
					content,
					movie_id: movieId,
					user_id: userId
				})
			});

			if (response.ok) {
				const comment = await response.json();
				// Gọi hàm để thêm comment vào danh sách
				addCommentToList(comment);
			} else {
				const errorText = await response.text();
				console.error('Failed to add comment:', response.status, errorText);
			}
		}

		// Hàm để thêm comment vào danh sách
		function addCommentToList(comment) {
			const commentsList = document.querySelector('.comments__list');
			const commentItem = document.createElement('li');
			commentItem.classList.add('comments__item');

			// Chắc chắn rằng bạn sử dụng đúng tên trường từ phản hồi
			commentItem.innerHTML = `
        <div class="comments__autor">
            <img class="comments__avatar" src="img/user.svg" alt="">
            <span class="comments__name">${comment.user_name}</span>
            <span class="comments__time">${formatDate(comment.created_at)}</span>
        </div>
        <p class="comments__text">${comment.content}</p>
    `;
			commentsList.prepend(commentItem); // Thêm comment mới lên đầu danh sách
		}

		// Sự kiện khi form gửi comment
		document.getElementById('comment-form').addEventListener('submit', function(event) {
			event.preventDefault(); // Ngăn chặn form gửi
			const userId = parseInt(getUserIdFromToken(), 10); // Chuyển đổi thành số
			const movieId = parseInt(getMovieIdFromURL(), 10);
			const content = document.getElementById('comment-content').value;
			console.log('User ID:', userId);
			console.log('Movie ID:', movieId);
			console.log('Content:', content);
			if (userId && movieId && content) {
				addComment(userId, movieId, content);
				document.getElementById('comment-content').value = ''; // Xóa nội dung textarea sau khi gửi
			} else {
				alert('You must be logged in to comment');
			}
		});

		// Gọi hàm để tải các comment khi trang được tải
		document.addEventListener('DOMContentLoaded', () => {
			fetchComments();
			document.getElementById('more-comments').addEventListener('click', loadMoreComments);
		});
		// Giả sử bạn có một hàm để lấy User ID
		// Hàm tạo bookmark
		// async function createBookmark(movieId) {
		// 	const userId = parseInt(getUserIdFromToken(),10);
		// 	const body = {
		// 		user_id: userId,
		// 		movie_id: movieId
		// 	};
		//
		// 	try {
		// 		const response = await fetch(`http://localhost:8080/api/v1/movie/bookmark`, {
		// 			method: 'POST',
		// 			headers: {
		// 				'Content-Type': 'application/json',
		// 				'Authorization': `Bearer ${localStorage.getItem('token')}`
		// 			},
		// 			body: JSON.stringify(body)
		// 		});
		//
		// 		if (response.ok) {
		// 			document.getElementById('bookmarkBtn').classList.add('bookmarked');
		// 			document.getElementById('bookmarkBtn').classList.remove('unbookmarked');
		// 			showMessage("Bookmark added!");
		// 		} else {
		// 			const errorResponse = await response.json();
		// 			showMessage(errorResponse.message);
		// 		}
		// 	} catch (error) {
		// 		console.error("Error creating bookmark:", error);
		// 		showMessage("An error occurred while adding bookmark.");
		// 	}
		// }

		// Hàm hủy bookmark
		// async function cancelBookmark(movieId) {
		// 	const userId = parseInt(getUserIdFromToken(),10);
		// 	const body = {
		// 		user_id: userId,
		// 		movie_id: movieId
		// 	};
		//
		// 	try {
		// 		const response = await fetch(`http://localhost:8080/api/v1/movie/bookmark`, {
		// 			method: 'DELETE',
		// 			headers: {
		// 				'Content-Type': 'application/json',
		// 				'Authorization': `Bearer ${localStorage.getItem('token')}`
		// 			},
		// 			body: JSON.stringify(body)
		// 		});
		//
		// 		if (response.ok) {
		// 			const bookmarkBtn = document.getElementById('bookmarkBtn');
		// 			document.getElementById('bookmarkBtn').classList.add('unbookmarked');
		// 			document.getElementById('bookmarkBtn').classList.remove('bookmarked');
		// 			showMessage("Bookmark removed!");
		// 		} else {
		// 			const errorResponse = await response.json();
		// 			showMessage(errorResponse.message);
		// 		}
		// 	} catch (error) {
		// 		console.error("Error cancelling bookmark:", error);
		// 		showMessage("An error occurred while removing bookmark.");
		// 	}
		// }

		// Hàm kiểm tra trạng thái bookmark
		// async function checkBookmarkStatus(movieId) {
		// 	const userId = getUserIdFromToken();
		// 	if (!userId) {
		// 		// Nếu người dùng chưa đăng nhập, hiển thị chưa bookmark và dừng xử lý
		// 		const bookmarkBtn = document.getElementById('bookmarkBtn');
		// 		bookmarkBtn.classList.add('unbookmarked');
		// 		return;
		// 	}
		//
		// 	try {
		// 		const response = await fetch(`http://localhost:8080/api/v1/bookmark/exist`, {
		// 			method: 'POST',
		// 			headers: {
		// 				'Content-Type': 'application/json',
		// 				'Authorization': `Bearer ${localStorage.getItem('token')}` // Gửi token nếu có
		// 			},
		// 			body: JSON.stringify({
		// 				movie_id: movieId,
		// 				user_id: parseInt(userId,10)
		// 			})
		// 		});
		//
		// 		if (!response.ok) {
		// 			throw new Error('Failed to check bookmark status');
		// 		}
		//
		// 		const result = await response.json();
		// 		const bookmarkBtn = document.getElementById('bookmarkBtn');
		//
		// 		if (result) {
		// 			bookmarkBtn.classList.remove('unbookmarked');
		// 			bookmarkBtn.classList.add('bookmarked');
		// 		} else {
		// 			bookmarkBtn.classList.remove('bookmarked');
		// 			bookmarkBtn.classList.add('unbookmarked');
		// 		}
		// 	} catch (error) {
		// 		console.error('Error checking bookmark status:', error);
		// 	}
		// }


		// Hàm hiển thị thông báo
		function showMessage(message) {
			const messageDiv = document.getElementById('bookmarkMessage');
			messageDiv.textContent = message;

			// Tự động xóa thông báo sau 3 giây
			setTimeout(() => {
				messageDiv.textContent = '';
			}, 3000);
		}

		// Thêm sự kiện cho nút bookmark
		// document.getElementById('bookmarkBtn').addEventListener('click', async () => {
		// 	const movieId = parseInt(getMovieIdFromURL(),10); // Thay đổi giá trị này cho ID phim bạn muốn
		//
		// 	const userId = getUserIdFromToken();
		// 	console.log('User ID:', userId);
		// 	console.log('Movie ID:', movieId);
		// 	if (!userId) {
		// 		// Nếu người dùng chưa đăng nhập, chuyển đến trang đăng nhập
		// 		window.location.href = '/signin'; // Đường dẫn đến trang đăng nhập của bạn
		// 		return;
		// 	}
		//
		// 	const bookmarkBtn = document.getElementById('bookmarkBtn');
		//
		// 	if (bookmarkBtn.classList.contains('unbookmarked')) {
		// 		// Nếu chưa bookmark, thực hiện tạo bookmark
		// 		await createBookmark(movieId);
		// 	} else {
		// 		// Nếu đã bookmark, thực hiện hủy bookmark
		// 		await cancelBookmark(movieId);
		// 	}
		// });
		//
		// // Kiểm tra trạng thái bookmark khi tải trang
		// document.addEventListener('DOMContentLoaded', () => {
		// 	const movieId = parseInt(getMovieIdFromURL(),10);
		// 	checkBookmarkStatus(movieId);
		// });
		document.addEventListener('DOMContentLoaded', function () {
			const stars = document.querySelectorAll('.star');
			let selectedRating = 0;

			// Sự kiện khi người dùng click vào một ngôi sao
			stars.forEach(star => {
				star.addEventListener('click', function () {
					selectedRating = parseInt(this.getAttribute('data-value'));
					updateStarRating(selectedRating);
				});
			});

			// Cập nhật màu ngôi sao khi được chọn
			function updateStarRating(rating) {
				stars.forEach(star => {
					star.classList.remove('selected');
				});
				for (let i = 0; i < rating; i++) {
					stars[i].classList.add('selected');
				}
			}

			// Lấy movieId từ URL và userId từ token
			const movieId = getMovieIdFromURL(); // Giả sử bạn đã có hàm này
			const userId = getUserIdFromToken(); // Giả sử bạn đã có hàm này

			// Sự kiện khi người dùng bấm nút Submit
			document.getElementById('submit-rating').addEventListener('click', async function () {
				if (selectedRating === 0) {
					alert('Please select a rating before submitting.');
					return;
				}

				try {
					const response = await fetch(`http://localhost:8080/api/v1/movie/${movieId}/rate`, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/x-www-form-urlencoded',
							'Authorization': `Bearer ${localStorage.getItem('token')}`
						},
						body: `user_id=${userId}&rate=${selectedRating}`
					});

					if (response.ok) {
						showMessage('Thank you for your rating!');
					} else {
						const errorData = await response.json();
						alert(`Error: ${errorData.error}`);
					}
				} catch (error) {
					console.error('Error:', error);
					alert('Failed to submit rating. Please try again later.');
				}
			});
		});
		document.addEventListener('DOMContentLoaded', async function() {
			const starRatingEl = document.querySelector('.star-fit-rating');
			const submitBtn = document.getElementById('submit-fit-rating');

			let selectedRating = 0; // Biến lưu rating mà người dùng chọn
			let categories = [];

			// Lấy userId từ URL
			const userId = getUserIdFromToken();

			const movieId = getMovieIdFromURL();

			// Gọi API để lấy các thể loại của phim
			async function fetchCategories() {
				try {
					const response = await fetch(`http://localhost:8080/api/v1/movie/${movieId}/category`, {
						headers: {
							'Authorization': `Bearer ${localStorage.getItem('token')}`,
							'Content-Type': 'application/json',
						},
					});
					categories = await response.json(); // Lưu danh sách thể loại vào biến categories
				} catch (error) {
					console.error('Error fetching categories:', error);
				}
			}

			// Thêm sự kiện click vào mỗi ngôi sao để chọn rating
			starRatingEl.addEventListener('click', function(event) {
				if (event.target.classList.contains('star-fit')) {
					selectedRating = parseInt(event.target.getAttribute('data-value'));
					console.log("fit:",selectedRating);// Chuyển đổi thành số nguyên
					highlightStars(selectedRating);
				}
			});

			// Hàm để làm nổi bật các sao theo rating
			function highlightStars(rating) {
				const stars = starRatingEl.querySelectorAll('.star-fit');
				stars.forEach(star => {
					// Xóa lớp 'selected' khỏi tất cả các sao
					star.classList.remove('selected');
					// Chỉ thêm lớp 'selected' cho những sao nhỏ hơn hoặc bằng rating
					if (parseInt(star.getAttribute('data-value')) <= rating) {
						star.classList.add('selected');
					}
				});
			}

			// Khi nhấn nút "Submit Rating"
			submitBtn.addEventListener('click', async function() {
				if (selectedRating > 0 && categories.length > 0) {
					// Gửi request cho mỗi thể loại
					for (const categoryId of categories) {
						try {
							const response = await fetch(`http://localhost:8080/api/v1/user/category-fit`, {
								method: 'POST',
								headers: {
									'Authorization': `Bearer ${localStorage.getItem('token')}`,
									'Content-Type': 'application/x-www-form-urlencoded',
								},
								body: `category_id=${parseInt(categoryId)}&fit_rate=${selectedRating}`,
							});
							if (response.ok) {
								showMessage('Rating for category saved!');
							} else {
								const errorData = await response.json();
								showMessage(`Error: ${errorData.error}`);
							}
						} catch (error) {
							console.log(error(`Error saving rating for category ${categoryId}:`, error));
						}
					}
				} else {
					alert('Please select a rating before submitting.');
				}
			});

			// Gọi API để lấy các thể loại khi trang được tải
			await fetchCategories();
		});

	</script>
	<script>
		const token = localStorage.getItem('token');
		const profileLink = document.getElementById('profileLink');
		const profileText = document.getElementById('profileText');

		if (token) {
			// Nếu có token, thay đổi liên kết thành trang profile và hiển thị 'PROFILE'
			profileLink.href = '/profile';
			profileText.textContent = 'PROFILE';
		} else {
			// Nếu không có token, dẫn đến trang đăng nhập và hiển thị 'SIGN IN'
			profileLink.href = '/signin';
			profileText.textContent = 'SIGN IN';
		}
		document.addEventListener("DOMContentLoaded", async () => {
			try {
				const response = await fetch('http://localhost:8080/api/v1/movie/most-views/6', {
					method: 'GET',
				});
				const movies = await response.json();

				const sidebarContainer = document.querySelector('#mostview');
				sidebarContainer.innerHTML = '<div className="col-12"> <h2 className="section__title section__title--sidebar" style="color: white">Most Popular Movie</h2> </div>';

				movies.forEach(movie => {
					const movieItem = `
        <div class="col-6 col-sm-4 col-lg-6">
          <div class="item">
            <div class="item__cover">
              <img src="${movie.thumbnail}" alt="${movie.name}">
              <a href="/detail?movieId=${movie.id}" class="item__play">
                <i class="ti ti-player-play-filled"></i>
              </a>
              <span class="item__rate item__rate--green">${movie.rate}</span>
            </div>
            <div class="item__content">
              <h3 class="item__title"><a href="/detail?movieId=${movie.id}">${movie.name}</a></h3>
              <span class="item__category">
  ${movie.category ? movie.category.map(cat => `<a href="#">${cat}</a>`).join(' ') : ''}
              </span>
            </div>
          </div>
        </div>
      `;
					sidebarContainer.insertAdjacentHTML('beforeend', movieItem);
				});
			} catch (error) {
				console.error('Error fetching movies:', error);
			}
		});
		document.addEventListener('DOMContentLoaded', function() {
			const searchBtn = document.getElementById('search-btn');
			const searchInput = document.getElementById('search-input');

			// Sự kiện khi người dùng nhấn nút tìm kiếm
			searchBtn.addEventListener('click', function() {
				const query = searchInput.value.trim(); // Lấy giá trị từ input

				if (query === '') {
					alert('Please enter a search term');
					return;
				}

				const page = 1;
				const limit = 18;

				// Tạo URL với query parameters
				const searchUrl = `/search?q=${encodeURIComponent(query)}&page=${page}&limit=${limit}`;

				// Chuyển hướng đến trang kết quả tìm kiếm
				window.location.href = searchUrl;
			});
		});
	</script>
</body>

<!-- Mirrored from hotflix.volkovdesign.com/main/watch.html by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 01 Oct 2024 14:32:55 GMT -->
</html>